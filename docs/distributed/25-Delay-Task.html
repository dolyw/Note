<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>延迟任务场景技术选型 | 笔记</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="https://cdn.jsdelivr.net/gh/wliduo/Index@master/static/favicon.ico">
    <script type="text/javascript" src="https://unpkg.com/valine@1.4.14/dist/Valine.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/gh/wliduo/Index@master/static/count.js"></script>
    <meta name="description" content="世界上最大的谎言就是你不行">
    
    <link rel="preload" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/css/0.styles.61f57d37.css" as="style"><link rel="preload" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/app.3bad5e8d.js" as="script"><link rel="preload" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/2.a354e7c3.js" as="script"><link rel="preload" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/73.90ca6c4e.js" as="script"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/10.702aa296.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/100.635ed39f.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/101.a55ab162.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/102.45a961f7.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/103.aa60491d.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/104.90cdb7e6.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/105.4d36c00c.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/106.2fcb9f72.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/107.4b9abb94.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/108.886251f4.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/109.56697f20.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/11.208a357c.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/110.6cb0b4b6.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/111.e1a58177.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/112.e372d681.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/113.88ec96a3.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/114.4c4da26c.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/115.5621beea.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/116.5a614edf.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/117.9b11342f.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/118.3e6ba433.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/119.86990d02.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/12.1e29199c.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/120.a34c27b4.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/121.5e633ae7.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/122.87c54fba.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/123.222952ed.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/124.4efb68b9.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/125.f5c8e38f.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/126.2751b73a.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/127.0bcdb7da.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/128.3ee5a25a.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/129.b30aa4f9.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/13.2ad0291a.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/130.142a0db2.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/131.d6cf6eae.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/132.d1bf115c.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/133.64203c3f.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/134.69061ee3.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/135.5345e953.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/136.f0468be5.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/137.9383ef07.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/138.36e7efa5.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/139.86607e15.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/14.be27efa5.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/140.3184f3f3.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/141.5921063f.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/142.b9405d5c.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/143.7758b243.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/144.c2395c64.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/145.d5a49bc8.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/146.1bdb0cc9.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/147.bb5c1fa7.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/148.385aabf4.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/149.8d442dcb.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/15.4dc09b4e.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/150.7ff746f0.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/151.bc06a3ae.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/152.25f73b6c.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/153.7a0c46e3.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/154.01bf343c.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/155.c41beba3.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/156.915c6c5c.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/157.b674823d.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/158.a97a26e1.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/159.5ed387b9.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/16.63250d63.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/160.570b5b2f.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/161.1b5e0354.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/162.352125c8.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/163.cebf1dd2.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/164.79e646f8.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/165.73b1e536.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/166.be136371.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/167.250b759c.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/168.79a8abed.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/169.2ca01418.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/17.de153d95.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/170.f2073a05.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/171.c74cdd89.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/172.2238d589.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/173.48120f50.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/174.b7ba70b7.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/175.60a1be92.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/176.2a6ce7d3.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/177.0cd9dfe0.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/178.fef1bad5.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/179.572ded04.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/18.e3aeb3db.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/180.398b71d6.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/19.126bb80d.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/20.00a8acc6.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/21.140024a5.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/22.56709e9a.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/23.28c73515.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/24.7a866742.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/25.f0cc94e9.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/26.c665e265.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/27.2273637b.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/28.6b1f8205.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/29.b4a6ea2a.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/3.cf8b60e0.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/30.fca119fc.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/31.cf9fe4c1.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/32.db1bd79d.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/33.ccd246c7.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/34.18089fe1.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/35.67b25af2.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/36.bd7bc6e0.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/37.cbdff8b4.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/38.2c1b5ae2.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/39.dbe7d83b.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/4.2aca6af0.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/40.03897d8e.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/41.71bd81ef.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/42.6108b1ad.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/43.d55f9886.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/44.d55ffc21.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/45.32d5ad0c.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/46.e54a2372.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/47.1611f8da.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/48.a2dd55dd.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/49.3aacab9b.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/5.eaaa8088.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/50.839f4f1b.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/51.c55743c0.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/52.8ec17525.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/53.2fa474f7.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/54.42c7c187.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/55.0a9ddb01.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/56.5031335d.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/57.495cb4fc.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/58.31df4ef1.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/59.7efcc3ae.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/6.66e3994a.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/60.51809cc4.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/61.7e83e65e.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/62.7569b78d.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/63.34ea0da1.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/64.dc5e25c7.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/65.8102bf6a.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/66.39a24d02.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/67.a8ae243e.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/68.e33a1768.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/69.de76140f.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/7.708d0fec.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/70.ecf1ce7e.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/71.1183d8a4.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/72.b1bf3244.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/74.a5bcb5ab.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/75.a4e7bf86.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/76.2909f881.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/77.8c0ee4a0.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/78.a3a3bb18.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/79.c0b78029.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/8.021936d4.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/80.99845ab8.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/81.18adbaf4.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/82.7c15751b.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/83.1e9be8b7.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/84.7e63ae3c.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/85.a57abf7c.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/86.d0faa9e7.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/87.7d794910.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/88.9477f3bf.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/89.a4abaa05.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/9.27654444.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/90.4730876e.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/91.eff5b8eb.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/92.12bd21f9.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/93.d7bbcb6a.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/94.e640d92b.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/95.696dd7ca.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/96.66e48cd6.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/97.4e139588.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/98.15844990.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/99.1f50002f.js">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/css/0.styles.61f57d37.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">笔记</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/map.html" class="nav-link">
  整站地图
</a></div><div class="nav-item"><a href="/study.html" class="nav-link">
  学习目录
</a></div><div class="nav-item"><a href="/project.html" class="nav-link">
  开源项目
</a></div><div class="nav-item"><a href="/issues.html" class="nav-link">
  疑问提交
</a></div> <a href="https://github.com/dolyw" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/map.html" class="nav-link">
  整站地图
</a></div><div class="nav-item"><a href="/study.html" class="nav-link">
  学习目录
</a></div><div class="nav-item"><a href="/project.html" class="nav-link">
  开源项目
</a></div><div class="nav-item"><a href="/issues.html" class="nav-link">
  疑问提交
</a></div> <a href="https://github.com/dolyw" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><a href="/distributed/" aria-current="page" class="sidebar-link">Distributed</a></li><li><a href="/distributed/00-CAP-BASE.html" class="sidebar-link">CAP和BASE理论</a></li><li><a href="/distributed/01-Design-Thinking.html" class="sidebar-link">秒杀系统的设计思考</a></li><li><a href="/distributed/02-Distributed-Limit.html" class="sidebar-link">高并发下的限流分析</a></li><li><a href="/distributed/10-Distributed-Session.html" class="sidebar-link">浅析分布式Session</a></li><li><a href="/distributed/12-Distributed-Lock.html" class="sidebar-link">浅析分布式锁</a></li><li><a href="/distributed/13-Distributed-ID.html" class="sidebar-link">浅析分布式ID</a></li><li><a href="/distributed/11-Distributed-Transaction.html" class="sidebar-link">浅析分布式事务</a></li><li><a href="/distributed/20-Distributed-Job.html" class="sidebar-link">浅析分布式任务调度</a></li><li><a href="/distributed/25-Delay-Task.html" aria-current="page" class="active sidebar-link">延迟任务场景技术选型</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/distributed/25-Delay-Task.html#_1-delayqueue" class="sidebar-link">1. DelayQueue</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/distributed/25-Delay-Task.html#_1-1-main" class="sidebar-link">1.1. Main</a></li></ul></li><li class="sidebar-sub-header"><a href="/distributed/25-Delay-Task.html#_2-hashedwheeltimer" class="sidebar-link">2. HashedWheelTimer</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/distributed/25-Delay-Task.html#_2-1-pom" class="sidebar-link">2.1. pom</a></li><li class="sidebar-sub-header"><a href="/distributed/25-Delay-Task.html#_2-2-task" class="sidebar-link">2.2. Task</a></li><li class="sidebar-sub-header"><a href="/distributed/25-Delay-Task.html#_2-3-main" class="sidebar-link">2.3. Main</a></li></ul></li><li class="sidebar-sub-header"><a href="/distributed/25-Delay-Task.html#_3-任务调度" class="sidebar-link">3. 任务调度</a></li><li class="sidebar-sub-header"><a href="/distributed/25-Delay-Task.html#_4-redis-zset" class="sidebar-link">4. Redis ZSet</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/distributed/25-Delay-Task.html#_4-1-pom" class="sidebar-link">4.1. pom</a></li><li class="sidebar-sub-header"><a href="/distributed/25-Delay-Task.html#_4-2-config" class="sidebar-link">4.2. Config</a></li><li class="sidebar-sub-header"><a href="/distributed/25-Delay-Task.html#_4-3-util" class="sidebar-link">4.3. Util</a></li><li class="sidebar-sub-header"><a href="/distributed/25-Delay-Task.html#_4-4-model" class="sidebar-link">4.4. Model</a></li><li class="sidebar-sub-header"><a href="/distributed/25-Delay-Task.html#_4-5-impl" class="sidebar-link">4.5. Impl</a></li></ul></li><li class="sidebar-sub-header"><a href="/distributed/25-Delay-Task.html#_5-redis键通知" class="sidebar-link">5. Redis键通知</a></li><li class="sidebar-sub-header"><a href="/distributed/25-Delay-Task.html#_6-mq延迟队列" class="sidebar-link">6. MQ延迟队列</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/distributed/25-Delay-Task.html#_6-1-rabbitmq" class="sidebar-link">6.1. RabbitMQ</a></li></ul></li></ul></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="延迟任务场景技术选型"><a href="#延迟任务场景技术选型" class="header-anchor">#</a> 延迟任务场景技术选型</h1> <p>实现延迟任务的方式有很多，各有利弊，有单机和分布式的，延迟任务有别于定式任务，定式任务往往是固定周期的，有明确的触发时间，场景很多</p> <ul><li>支付超时取消订单</li> <li>评价超时自动好评</li> <li>...</li></ul> <p>下面来探讨一些实现方案</p> <h2 id="_1-delayqueue"><a href="#_1-delayqueue" class="header-anchor">#</a> 1. DelayQueue</h2> <p>缺点是<strong>单机运行在内存中导致 OOM、无法持久化、宕机任务丢失</strong></p> <ul><li>Github: <a href="https://github.com/dolyw/ProjectStudy/blob/master/JavaSource/src/test/java/containers/T04_BlockingQueue_3_DelayQueue.java" target="_blank" rel="noopener noreferrer">https://github.com/dolyw/ProjectStudy/blob/master/JavaSource/src/test/java/containers/T04_BlockingQueue_3_DelayQueue.java<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li>Gitee(码云): <a href="https://gitee.com/dolyw/ProjectStudy/blob/master/JavaSource/src/test/java/containers/T04_BlockingQueue_3_DelayQueue.java" target="_blank" rel="noopener noreferrer">https://gitee.com/dolyw/ProjectStudy/blob/master/JavaSource/src/test/java/containers/T04_BlockingQueue_3_DelayQueue.java<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <h3 id="_1-1-main"><a href="#_1-1-main" class="header-anchor">#</a> 1.1. Main</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent</span><span class="token punctuation">.</span>*<span class="token punctuation">;</span>

<span class="token comment">/**
 * DelayQueue - 按时间排序出队列
 *
 * 任务调度 - 定时任务 - 延时队列
 *
 * @author wliduo[i@dolyw.com]
 * @date 2020/4/23 15:35
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">T04_BlockingQueue_3_DelayQueue</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">BlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MyTask</span><span class="token punctuation">&gt;</span></span> tasks <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DelayQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">MyTask</span> <span class="token keyword">implements</span> <span class="token class-name">Delayed</span> <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token keyword">long</span> runningTime<span class="token punctuation">;</span>

        <span class="token class-name">MyTask</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token keyword">long</span> rt<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>runningTime <span class="token operator">=</span> rt<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">compareTo</span><span class="token punctuation">(</span><span class="token class-name">Delayed</span> o<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getDelay</span><span class="token punctuation">(</span><span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">)</span> <span class="token operator">&lt;</span> o<span class="token punctuation">.</span><span class="token function">getDelay</span><span class="token punctuation">(</span><span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getDelay</span><span class="token punctuation">(</span><span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">)</span> <span class="token operator">&gt;</span> o<span class="token punctuation">.</span><span class="token function">getDelay</span><span class="token punctuation">(</span><span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">getDelay</span><span class="token punctuation">(</span><span class="token class-name">TimeUnit</span> unit<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> unit<span class="token punctuation">.</span><span class="token function">convert</span><span class="token punctuation">(</span>runningTime <span class="token operator">-</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> name <span class="token operator">+</span> <span class="token string">&quot; &quot;</span> <span class="token operator">+</span> runningTime<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token keyword">long</span> now <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">MyTask</span> t1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyTask</span><span class="token punctuation">(</span><span class="token string">&quot;t1&quot;</span><span class="token punctuation">,</span> now <span class="token operator">+</span> <span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">MyTask</span> t2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyTask</span><span class="token punctuation">(</span><span class="token string">&quot;t2&quot;</span><span class="token punctuation">,</span> now <span class="token operator">+</span> <span class="token number">20000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">MyTask</span> t3 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyTask</span><span class="token punctuation">(</span><span class="token string">&quot;t3&quot;</span><span class="token punctuation">,</span> now <span class="token operator">+</span> <span class="token number">15000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">MyTask</span> t4 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyTask</span><span class="token punctuation">(</span><span class="token string">&quot;t4&quot;</span><span class="token punctuation">,</span> now <span class="token operator">+</span> <span class="token number">25000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">MyTask</span> t5 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyTask</span><span class="token punctuation">(</span><span class="token string">&quot;t5&quot;</span><span class="token punctuation">,</span> now <span class="token operator">+</span> <span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        tasks<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>t1<span class="token punctuation">)</span><span class="token punctuation">;</span>
        tasks<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>t2<span class="token punctuation">)</span><span class="token punctuation">;</span>
        tasks<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>t3<span class="token punctuation">)</span><span class="token punctuation">;</span>
        tasks<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>t4<span class="token punctuation">)</span><span class="token punctuation">;</span>
        tasks<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>t5<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>tasks<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">/*for (int i = 0; i &lt; 5; i++) {
            System.out.println(tasks.take());
        }

        tasks.put(t1);
        tasks.put(t2);
        tasks.put(t3);
        tasks.put(t4);
        tasks.put(t5);*/</span>

        <span class="token class-name">MyTask</span> t <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>tasks<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            t <span class="token operator">=</span> tasks<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>runningTime <span class="token operator">+</span> <span class="token string">&quot;, &quot;</span> <span class="token operator">+</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="_2-hashedwheeltimer"><a href="#_2-hashedwheeltimer" class="header-anchor">#</a> 2. HashedWheelTimer</h2> <p>Netty 提供的 HashedWheelTimer 工具类来实现延迟任务，采用时间轮算法，相比 DelayQueue 的数据结构，时间轮在算法复杂度上有一定优势。DelayQueue 由于涉及到排序，需要调堆，插入和移除的复杂度是 O(lgn)，而时间轮在插入和移除的复杂度都是 O(1)</p> <p>缺点是<strong>单机运行在内存中导致 OOM、无法持久化、宕机任务丢失</strong></p> <ul><li>Github: <a href="https://github.com/dolyw/ProjectStudy/tree/master/SpringBoot/DelayTask" target="_blank" rel="noopener noreferrer">https://github.com/dolyw/ProjectStudy/tree/master/SpringBoot/DelayTask<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li>Gitee(码云): <a href="https://gitee.com/dolyw/ProjectStudy/tree/master/SpringBoot/DelayTask" target="_blank" rel="noopener noreferrer">https://gitee.com/dolyw/ProjectStudy/tree/master/SpringBoot/DelayTask<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <h3 id="_2-1-pom"><a href="#_2-1-pom" class="header-anchor">#</a> 2.1. pom</h3> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token comment">&lt;!-- HashedWheelTimer --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>io.netty<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>netty-common<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>4.1.23.Final<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h3 id="_2-2-task"><a href="#_2-2-task" class="header-anchor">#</a> 2.2. Task</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * HashedWheelTimer实现
 *
 * @author wliduo[i@dolyw.com]
 * @date 2020/8/14 11:50
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomTimerTask</span> <span class="token keyword">implements</span> <span class="token class-name">TimerTask</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">DateTimeFormatter</span> <span class="token class-name">F</span> <span class="token operator">=</span> <span class="token class-name">DateTimeFormatter</span><span class="token punctuation">.</span><span class="token function">ofPattern</span><span class="token punctuation">(</span><span class="token string">&quot;yyyy-MM-dd HH:mm:ss.SSS&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 任务ID
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">long</span> taskId<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 创建时间戳
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">long</span> timestamp<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">CustomTimerTask</span><span class="token punctuation">(</span><span class="token keyword">long</span> taskId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>taskId <span class="token operator">=</span> taskId<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>timestamp <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">Timeout</span> timeout<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 异步处理任务</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>
                <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;任务执行时间:%s，任务创建时间:%s，任务ID:%s&quot;</span><span class="token punctuation">,</span>
                        <span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token class-name">F</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">ofInstant</span><span class="token punctuation">(</span><span class="token class-name">Instant</span><span class="token punctuation">.</span><span class="token function">ofEpochMilli</span><span class="token punctuation">(</span>timestamp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">ZoneId</span><span class="token punctuation">.</span><span class="token function">systemDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token class-name">F</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        taskId
                <span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_2-3-main"><a href="#_2-3-main" class="header-anchor">#</a> 2.3. Main</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * RunHashedWheelTimer运行
 *
 * @author wliduo[i@dolyw.com]
 * @date 2020/8/14 11:54
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RunHashedWheelTimer</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">DateTimeFormatter</span> <span class="token class-name">F</span> <span class="token operator">=</span> <span class="token class-name">DateTimeFormatter</span><span class="token punctuation">.</span><span class="token function">ofPattern</span><span class="token punctuation">(</span><span class="token string">&quot;yyyy-MM-dd HH:mm:ss.SSS&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>

        <span class="token class-name">ThreadFactory</span> factory <span class="token operator">=</span> r <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token class-name">Thread</span> thread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
            thread<span class="token punctuation">.</span><span class="token function">setDaemon</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            thread<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">&quot;HashedWheelTimerWorker&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> thread<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

        <span class="token comment">/**
         * @param tickDuration 每tick一次的时间间隔
         * @param unit tickDuration的时间单位
         * @param ticksPerWheel 时间轮中的槽数
         * @param leakDetection 检查内存溢出
         */</span>
        <span class="token class-name">Timer</span> timer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashedWheelTimer</span><span class="token punctuation">(</span>factory<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span>
                <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;开始任务时间:%s&quot;</span><span class="token punctuation">,</span> <span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token class-name">F</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 任务ID-6，5秒后执行</span>
        <span class="token class-name">TimerTask</span> timerTask <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CustomTimerTask</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        timer<span class="token punctuation">.</span><span class="token function">newTimeout</span><span class="token punctuation">(</span>timerTask<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">.</span>MAX_VALUE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><h2 id="_3-任务调度"><a href="#_3-任务调度" class="header-anchor">#</a> 3. 任务调度</h2> <p>任务调度按设定时间间隔执行一次，及时性可能没有那么块，必须等到任务调用执行，选取那种任务调度框架(Quartz，XXL-JOB，OhMyScheduler等)了</p> <p><strong>缺点是需要全表扫描(当然可以每次处理指定时间段的数据)</strong>，任务设置轮询时间就是最大延迟时间，对数据库有一定压力，<strong>仅适合数据量少的业务场景</strong></p> <h2 id="_4-redis-zset"><a href="#_4-redis-zset" class="header-anchor">#</a> 4. Redis ZSet</h2> <p>Redis 中的 ZSet 是一个有序的 Set，内部使用 HashMap 和跳表(SkipList)来保证数据的存储和有序，HashMap 里放的是成员到 score 的映射，而跳跃表里存放的是所有的成员，排序依据是 HashMap 里存的 score，使用跳跃表的结构可以获得比较高的查找效率，并且在实现上比较简单，借助 ZSet 数据类型，把延迟任务存储在此数据集合中，然后在开启一个无线循环查询当前时间的所有任务进行消费</p> <p>但是可能有并发问题，即两个线程或者两个进程都会拿到一样的数据，然后重复执行，最后又都会删除。如果是单机多线程执行，或者分布式环境下，可以使用 Redis 事务，也可以使用由 Redis 实现的分布式锁，或者使用下例中 Redis Script。你可以在 Redis 官方的 Transaction 章节找到事务的相关内容</p> <p><strong>这种方式比较推荐，可以满足持久化，分布式的场景</strong>，使用的话，Redisson 框架有封装好，直接使用即可，如下简单实现一个订单超时自动评价功能</p> <ul><li>Github: <a href="https://github.com/dolyw/ProjectStudy/tree/master/SpringBoot/DelayTask" target="_blank" rel="noopener noreferrer">https://github.com/dolyw/ProjectStudy/tree/master/SpringBoot/DelayTask<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li>Gitee(码云): <a href="https://gitee.com/dolyw/ProjectStudy/tree/master/SpringBoot/DelayTask" target="_blank" rel="noopener noreferrer">https://gitee.com/dolyw/ProjectStudy/tree/master/SpringBoot/DelayTask<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <h3 id="_4-1-pom"><a href="#_4-1-pom" class="header-anchor">#</a> 4.1. pom</h3> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token comment">&lt;!-- JDK 1.6+ compatible --&gt;</span>
<span class="token comment">&lt;!--&lt;dependency&gt;
    &lt;groupId&gt;org.redisson&lt;/groupId&gt;
    &lt;artifactId&gt;redisson&lt;/artifactId&gt;
    &lt;version&gt;2.10.4&lt;/version&gt;
&lt;/dependency&gt;--&gt;</span>

<span class="token comment">&lt;!-- JDK 1.8+ compatible，Redisson包含了netty --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.redisson<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>redisson<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.12.1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h3 id="_4-2-config"><a href="#_4-2-config" class="header-anchor">#</a> 4.2. Config</h3> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">redis</span><span class="token punctuation">:</span>
    <span class="token key atrule">database</span><span class="token punctuation">:</span> <span class="token number">2</span>
    <span class="token key atrule">host</span><span class="token punctuation">:</span> 127.0.0.1
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">6379</span>
    <span class="token key atrule">password</span><span class="token punctuation">:</span> 
</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * RedissonConfig配置
 *
 * @author wliduo[i@dolyw.com]
 * @date 2020/8/14 16:16
 */</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@ConfigurationProperties</span><span class="token punctuation">(</span>prefix <span class="token operator">=</span> <span class="token string">&quot;spring.redis&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RedissonConfig</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Logger</span> logger <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">RedissonConfig</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> host<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">int</span> port<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> password<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">int</span> database<span class="token punctuation">;</span>

    <span class="token comment">/**
     * RedissonClient配置
     *
     * @param
     * @return org.redisson.api.RedissonClient
     * @throws
     * @author wliduo[i@dolyw.com]
     * @date 2020/8/14 16:25
     */</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">RedissonClient</span> <span class="token function">redissonClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">RedissonClient</span> redissonClient <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token class-name">Config</span> config <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> url <span class="token operator">=</span> <span class="token string">&quot;redis://&quot;</span> <span class="token operator">+</span> host <span class="token operator">+</span> <span class="token string">&quot;:&quot;</span> <span class="token operator">+</span> port<span class="token punctuation">;</span>
        <span class="token comment">// 单节点配置</span>
        config<span class="token punctuation">.</span><span class="token function">useSingleServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAddress</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setDatabase</span><span class="token punctuation">(</span>database<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 主从配置</span>
        <span class="token comment">/*config.useMasterSlaveServers()
                // 设置redis主节点
                .setMasterAddress(&quot;redis://192.168.1.120:6379&quot;)
                // 设置redis从节点
                .addSlaveAddress(&quot;redis://192.168.1.130:6379&quot;, &quot;redis://192.168.1.140:6379&quot;);*/</span>
        <span class="token comment">// 哨兵部署方式，sentinel是采用Paxos拜占庭协议，一般sentinel至少3个节点</span>
        <span class="token comment">/*config.useSentinelServers()
                .setMasterName(&quot;my-sentinel-name&quot;)
                .addSentinelAddress(&quot;redis://192.168.1.120:6379&quot;)
                .addSentinelAddress(&quot;redis://192.168.1.130:6379&quot;)
                .addSentinelAddress(&quot;redis://192.168.1.140:6379&quot;);*/</span>
        <span class="token comment">// 集群部署方式，cluster方式至少6个节点，3主3从，3主做sharding，3从用来保证主宕机后可以高可用</span>
        <span class="token comment">/*config.useClusterServers()
                // 集群状态扫描间隔时间，单位是毫秒
                .setScanInterval(2000)
                .addNodeAddress(&quot;redis://192.168.1.120:6379&quot;)
                .addNodeAddress(&quot;redis://192.168.1.130:6379&quot;)
                .addNodeAddress(&quot;redis://192.168.1.140:6379&quot;)
                .addNodeAddress(&quot;redis://192.168.1.150:6379&quot;)
                .addNodeAddress(&quot;redis://192.168.1.160:6379&quot;)
                .addNodeAddress(&quot;redis://192.168.1.170:6379&quot;);*/</span>
        <span class="token comment">// 云托管部署方式，这种方式主要解决redis提供商为云服务的提供商的redis连接，比如亚马逊云、微软云</span>
        <span class="token comment">/*config.useReplicatedServers()
                // 主节点变化扫描间隔时间
                .setScanInterval(2000)
                .addNodeAddress(&quot;redis://192.168.1.120:6379&quot;)
                .addNodeAddress(&quot;redis://192.168.1.130:6379&quot;)
                .addNodeAddress(&quot;redis://192.168.1.140:6379&quot;);*/</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            redissonClient <span class="token operator">=</span> <span class="token class-name">Redisson</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> redissonClient<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;RedissonClient init redis url:[{}], Exception:&quot;</span><span class="token punctuation">,</span> url<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getHost</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> host<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setHost</span><span class="token punctuation">(</span><span class="token class-name">String</span> host<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>host <span class="token operator">=</span> host<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> port<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setPort</span><span class="token punctuation">(</span><span class="token keyword">int</span> port<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>port <span class="token operator">=</span> port<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> password<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setPassword</span><span class="token punctuation">(</span><span class="token class-name">String</span> password<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>password <span class="token operator">=</span> password<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getDatabase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> database<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setDatabase</span><span class="token punctuation">(</span><span class="token keyword">int</span> database<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>database <span class="token operator">=</span> database<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_4-3-util"><a href="#_4-3-util" class="header-anchor">#</a> 4.3. Util</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * RedissonDelayedUtil
 *
 * @author wliduo[i@dolyw.com]
 * @date 2020/8/14 16:34
 */</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RedissonDelayedUtil</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Logger</span> logger <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">RedissonDelayedUtil</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">RedissonClient</span> redissonClient<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 添加延时队列任务
     *
     * @param blockingQueueName 队列名
	 * @param t 对象
	 * @param delay 时间
	 * @param timeUnit 时间单位
     * @return boolean
     * @throws
     * @author wliduo[i@dolyw.com]
     * @date 2020/8/14 16:41
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">offer</span><span class="token punctuation">(</span><span class="token class-name">String</span> blockingQueueName<span class="token punctuation">,</span> <span class="token class-name">T</span> t<span class="token punctuation">,</span> <span class="token keyword">long</span> delay<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span> timeUnit<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">RBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> blockingQueue <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token class-name">RDelayedQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> delayedQueue <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            blockingQueue <span class="token operator">=</span> redissonClient<span class="token punctuation">.</span><span class="token function">getBlockingQueue</span><span class="token punctuation">(</span>blockingQueueName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            delayedQueue <span class="token operator">=</span> redissonClient<span class="token punctuation">.</span><span class="token function">getDelayedQueue</span><span class="token punctuation">(</span>blockingQueue<span class="token punctuation">)</span><span class="token punctuation">;</span>
            delayedQueue<span class="token punctuation">.</span><span class="token function">offer</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> delay<span class="token punctuation">,</span> timeUnit<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// https://blog.csdn.net/zsj777/article/details/105223853</span>
            <span class="token comment">// 解决延迟队列take数据阻塞不执行，必须等到下一个内容offer时，队列才会把阻塞的消息全部处理掉</span>
            <span class="token comment">// offer后再offer一个空值即可</span>
            delayedQueue<span class="token punctuation">.</span><span class="token function">offer</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;RedissonDelayedUtil put Exception:&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>delayedQueue <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                delayedQueue<span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 获取延时队列任务
     *
     * @param blockingQueueName 队列名
     * @return org.redisson.api.RBlockingQueue&lt;T&gt;
     * @throws
     * @author wliduo[i@dolyw.com]
     * @date 2020/8/14 17:03
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">RBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">take</span><span class="token punctuation">(</span><span class="token class-name">String</span> blockingQueueName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">RBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> blockingQueue <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token class-name">RDelayedQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> delayedQueue <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            blockingQueue <span class="token operator">=</span> redissonClient<span class="token punctuation">.</span><span class="token function">getBlockingQueue</span><span class="token punctuation">(</span>blockingQueueName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            delayedQueue <span class="token operator">=</span> redissonClient<span class="token punctuation">.</span><span class="token function">getDelayedQueue</span><span class="token punctuation">(</span>blockingQueue<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 解决延迟队列首次启动获取为空的问题，先offer一个空值就没问题了</span>
            delayedQueue<span class="token punctuation">.</span><span class="token function">offer</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> blockingQueue<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;RedissonDelayedUtil put Exception:&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>delayedQueue <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                delayedQueue<span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><h3 id="_4-4-model"><a href="#_4-4-model" class="header-anchor">#</a> 4.4. Model</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * OrderDto
 *
 * @author wliduo[i@dolyw.com]
 * @date 2020/8/14 16:31
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderDto</span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{</span>

    <span class="token comment">/**
     * 订单号
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> orderCode<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 订单名
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> orderName<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">OrderDto</span><span class="token punctuation">(</span><span class="token class-name">String</span> orderCode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>orderCode <span class="token operator">=</span> orderCode<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">OrderDto</span><span class="token punctuation">(</span><span class="token class-name">String</span> orderCode<span class="token punctuation">,</span> <span class="token class-name">String</span> orderName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>orderCode <span class="token operator">=</span> orderCode<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>orderName <span class="token operator">=</span> orderName<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getOrderCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> orderCode<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setOrderCode</span><span class="token punctuation">(</span><span class="token class-name">String</span> orderCode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>orderCode <span class="token operator">=</span> orderCode<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getOrderName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> orderName<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setOrderName</span><span class="token punctuation">(</span><span class="token class-name">String</span> orderName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>orderName <span class="token operator">=</span> orderName<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * RedissonDelayedQueue枚举
 *
 * @author wliduo[i@dolyw.com]
 * @date 2020/8/14 16:43
 */</span>
<span class="token keyword">public</span> <span class="token keyword">enum</span> <span class="token class-name">RedissonDelayedEnum</span> <span class="token punctuation">{</span>

    <span class="token comment">/**
     * 订单超时默认评价
     */</span>
    <span class="token function">ORDER_DEFAULT_EVALUATION</span><span class="token punctuation">(</span><span class="token string">&quot;orderDefaultEvaluation&quot;</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MINUTES<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">int</span> delay<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">TimeUnit</span> timeUnit<span class="token punctuation">;</span>

    <span class="token class-name">RedissonDelayedEnum</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token keyword">int</span> delay<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span> timeUnit<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>delay <span class="token operator">=</span> delay<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>timeUnit <span class="token operator">=</span> timeUnit<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_4-5-impl"><a href="#_4-5-impl" class="header-anchor">#</a> 4.5. Impl</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * Redisson延时队列测试
 *
 * @author wliduo[i@dolyw.com]
 * @date 2020/8/14 16:23
 */</span>
<span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WebController</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">RedissonDelayedUtil</span> redissonDelayedUtil<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@GetMapping</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;Hello World&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/put&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 10秒后执行</span>
        redissonDelayedUtil<span class="token punctuation">.</span><span class="token function">offer</span><span class="token punctuation">(</span><span class="token class-name">RedissonDelayedEnum</span><span class="token punctuation">.</span>ORDER_DEFAULT_EVALUATION<span class="token punctuation">.</span>name<span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">OrderDto</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;Test&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token class-name">RedissonDelayedEnum</span><span class="token punctuation">.</span>ORDER_DEFAULT_EVALUATION<span class="token punctuation">.</span>delay<span class="token punctuation">,</span>
                <span class="token class-name">RedissonDelayedEnum</span><span class="token punctuation">.</span>ORDER_DEFAULT_EVALUATION<span class="token punctuation">.</span>timeUnit<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/putName&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">putName</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 10秒后执行</span>
        redissonDelayedUtil<span class="token punctuation">.</span><span class="token function">offer</span><span class="token punctuation">(</span><span class="token class-name">RedissonDelayedEnum</span><span class="token punctuation">.</span>ORDER_DEFAULT_EVALUATION<span class="token punctuation">.</span>name<span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">OrderDto</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token class-name">RedissonDelayedEnum</span><span class="token punctuation">.</span>ORDER_DEFAULT_EVALUATION<span class="token punctuation">.</span>delay<span class="token punctuation">,</span>
                <span class="token class-name">RedissonDelayedEnum</span><span class="token punctuation">.</span>ORDER_DEFAULT_EVALUATION<span class="token punctuation">.</span>timeUnit<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * 延时任务启动执行，自动消费
 *
 * @author wliduo[i@dolyw.com]
 * @date 2020/8/14 17:01
 */</span>
<span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@Order</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DelayedTask</span> <span class="token keyword">implements</span> <span class="token class-name">CommandLineRunner</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Logger</span> logger <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">DelayedTask</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">DateTimeFormatter</span> <span class="token class-name">F</span> <span class="token operator">=</span> <span class="token class-name">DateTimeFormatter</span><span class="token punctuation">.</span><span class="token function">ofPattern</span><span class="token punctuation">(</span><span class="token string">&quot;yyyy-MM-dd HH:mm:ss.SSS&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">RedissonDelayedUtil</span> redissonDelayedUtil<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">// 订单默认评价</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">orderDefaultEvaluation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 订单默认评价
     *
     * @param
     * @return void
     * @throws
     * @author wliduo[i@dolyw.com]
     * @date 2020/8/14 17:10
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">orderDefaultEvaluation</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token class-name">RBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderDto</span><span class="token punctuation">&gt;</span></span> blockingQueue <span class="token operator">=</span> redissonDelayedUtil<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token class-name">RedissonDelayedEnum</span><span class="token punctuation">.</span>ORDER_DEFAULT_EVALUATION<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>blockingQueue <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;延时任务启动失败&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">OrderDto</span> orderDto <span class="token operator">=</span> blockingQueue<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>orderDto <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;名称: {}，执行时间: {}，入队时间: {}&quot;</span><span class="token punctuation">,</span> orderDto<span class="token punctuation">.</span><span class="token function">getOrderName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token class-name">F</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">ofInstant</span><span class="token punctuation">(</span><span class="token class-name">Instant</span><span class="token punctuation">.</span><span class="token function">ofEpochMilli</span><span class="token punctuation">(</span>
                            <span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">parseLong</span><span class="token punctuation">(</span>orderDto<span class="token punctuation">.</span><span class="token function">getOrderCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">ZoneId</span><span class="token punctuation">.</span><span class="token function">systemDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token class-name">F</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><h2 id="_5-redis键通知"><a href="#_5-redis键通知" class="header-anchor">#</a> 5. Redis键通知</h2> <ul><li><a href="https://www.cnblogs.com/hld123/p/10812848.html" target="_blank" rel="noopener noreferrer">Redis键通知机制<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://blog.csdn.net/qq_42651904/article/details/106279593" target="_blank" rel="noopener noreferrer">Springboot+Redis实现过期键通知<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <p>Redis 键通知是不可靠的</p> <ul><li>开启键通知会对 Redis 有额外的开销</li> <li>键通知暂时 Redis 并不保证消息必达，Redis 客户端断开连接所有 Key 丢失</li> <li>消费速度不可自控，如果一瞬间 QPS 非常高，接收到的通知会非常密集，消费不过来</li></ul> <h2 id="_6-mq延迟队列"><a href="#_6-mq延迟队列" class="header-anchor">#</a> 6. MQ延迟队列</h2> <p>几乎所有的 MQ 中间件都可以实现延迟任务，在这里更准确的叫法应该叫延迟队列，MQ 可以做到消息零丢失，可抗高并发，需要额外引入 MQ 中间件，提高系统复杂性和 MQ 高可用维护性</p> <p>如果专门开启一个 MQ 中间件来执行延迟任务，就有点杀鸡用宰牛刀般的奢侈了，不过已经有了 MQ 环境的话，用它来实现延迟任务的话，还是可取的</p> <h3 id="_6-1-rabbitmq"><a href="#_6-1-rabbitmq" class="header-anchor">#</a> 6.1. RabbitMQ</h3> <p>由于使用死信交换器比较麻烦，所以推荐使用第二种实现方式 rabbitmq-delayed-message-exchange 插件的方式实现延迟队列</p> <ul><li>RabbitMQ 的 TTL 和 DXL 实现延迟队列，通过消息过期后进入死信交换器，再由交换器转发到延迟消费队列</li> <li>使用 rabbitmq-delayed-message-exchange 插件实现延迟功能</li></ul> <p>延迟插件 rabbitmq-delayed-message-exchange 是在 RabbitMQ 3.5.7 及以上的版本才支持的，依赖 Erlang/OPT 18.0 及以上运行环境</p> <p><strong>参考</strong></p> <ul><li><a href="https://blog.csdn.net/xybelieve1990/article/details/78040419" target="_blank" rel="noopener noreferrer">延迟任务的实现总结<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://www.cnblogs.com/vipstone/p/12696465.html" target="_blank" rel="noopener noreferrer">史上最全的延迟任务实现方式汇总！附代码（强烈推荐）<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://blog.csdn.net/qq_42651904/article/details/106279593" target="_blank" rel="noopener noreferrer">Springboot+Redis实现过期键通知（订单超时取消方案总结）<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/dolyw/Note/edit/master/doc/distributed/25-Delay-Task.md" target="_blank" rel="noopener noreferrer">在 GitHub 上编辑此页</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">上次更新时间:</span> <span class="time">2020-08-18 11:23:15</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/distributed/20-Distributed-Job.html" class="prev">
        浅析分布式任务调度
      </a></span> <!----></p></div> </main></div><div class="global-ui"><div class="diy-loader center" style="display:none;" data-v-184c1df1><div class="center-box" data-v-184c1df1><div class="loader_overlay" data-v-184c1df1></div> <div class="loader_cogs" data-v-184c1df1><div class="loader_cogs__top" data-v-184c1df1><div class="top_part" data-v-184c1df1></div> <div class="top_part" data-v-184c1df1></div> <div class="top_part" data-v-184c1df1></div> <div class="top_hole" data-v-184c1df1></div></div> <div class="loader_cogs__left" data-v-184c1df1><div class="left_part" data-v-184c1df1></div> <div class="left_part" data-v-184c1df1></div> <div class="left_part" data-v-184c1df1></div> <div class="left_hole" data-v-184c1df1></div></div> <div class="loader_cogs__bottom" data-v-184c1df1><div class="bottom_part" data-v-184c1df1></div> <div class="bottom_part" data-v-184c1df1></div> <div class="bottom_part" data-v-184c1df1></div> <div class="bottom_hole" data-v-184c1df1></div></div></div> <p class="loading-text" data-v-184c1df1>
      页面加载中<span class="dot" data-v-184c1df1>...</span></p></div></div><!----></div></div>
    <script src="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/app.3bad5e8d.js" defer></script><script src="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/2.a354e7c3.js" defer></script><script src="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/73.90ca6c4e.js" defer></script>
  </body>
</html>
